<!doctype html>
<html lang="ru" class="h-100">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>NAN</title>
  <link href="bootstrap-5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
  <link rel="stylesheet" href="cmn-toggle-switch/cmn-toggle-switch.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>

<body class="d-flex flex-column h-100">
  <nav class="navbar navbar-expand-md fixed-top">
    <div class="container">
      <a class="navbar-brand" href="index.html">Logo</a>
      <button class="navbar-toggler cmn-toggle-switch cmn-toggle-switch__htx" type="button" data-bs-toggle="collapse"
        data-bs-target="#nc" aria-controls="nc" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="nc">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" aria-current="page" href="./aboutProject.html">О проекте</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="./work.html">Как это работает</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="./getSmeta.html">Получить смету</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="./reviews.html">Отзывы</a>
          </li>
          <li class="nav-item">
            <a class="nav-link pe-0" href="./contacts.html">Контакты</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>



  <!-- Слой для затемнения (попап) -->
  <div class="popup-overlay" id="popupOverlay" style="display: none;" onclick="closePopupFromOverlay(event)">
    <!-- Контейнер для всплывающего окна -->
    <div class="popup-container" onclick="event.stopPropagation()">
      <!-- Кнопка закрытия -->
      <button class="popup-close-btn" onclick="closePopup()">×</button>

      <!-- Таблица для отображения данных -->
      <table id="dataTable">
        <thead>
          <tr>
            <th>Название товара</th>
            <th>Количество</th>
            <th>Цена</th>
            <th>Общая цена</th>
            <th>Данные получены</th>
          </tr>
        </thead>
        <tbody>
          <!-- Данные будут добавляться сюда -->
        </tbody>
      </table>

      <!-- Кнопка для сохранения данных в Excel -->
      <button type="button" class="exportExcel" onclick="exportToExcel()">Сохранить в Excel</button>
    </div>
  </div>




  <div class="container">
    <div class="row mb">
      <div class="w1 order-lg-1 order-2">
        <div class="card form_download h-100">
          <form action="" class="mx-auto w-100">
            <img src="im/download.png" alt="" class="img-fluid d-block mx-auto">
            <p class="text-center fw-medium">Выберите файл или перетащите его сюда</p>
            <p class="grey_light sm_txt">В формате .pdf.<br>В векторе.<br>Должны быть чертежи с размерами и спецификация
              материалов.</p>
            <p class="text-end sm_txt"><a href="" class="blue1 underline">подробнее о требованиях</a></p>
            <div class="form-controlDiv">
              <input class="form-control" type="file" id="pdfInput" accept="application/pdf">
              <button type="button" class="hover-form form-control" onclick="processPDF()">Обработать</button>
            </div>
          </form>
        </div>
      </div>
      <div class="w2 order-lg-2 order-1">
        <div class="swiper swiper_main h-100">
          <div class="swiper-wrapper">
            <div class="swiper-slide ss3">
              <div class="swiper_txt d-flex">
                <div class="my-auto">
                  <div class="head blue">Добро пожаловать на AI<br> по расчёту смет и<br> калькуляций!</div>
                  <p class="grey_light sm_txt">Должны быть чертежи с размерами и<br> спецификация материалов.</p>
                </div>
              </div>
              <div class="gradient_pic position-relative">
                <img src="im/s3.jpg" class="d-md-block d-none ms-auto" alt="">
                <img src="im/s3_med.jpg" class="d-md-none d-sm-block d-none ms-auto" alt="">
                <img src="im/s3_mob.jpg" class="d-sm-none d-block ms-auto" alt="">
              </div>
            </div>
            <div class="slider_nav">
              <div class="swiper_btns">
                <div class="swiper-button-prev"></div>
                <div class="swiper-button-next"></div>
              </div>
              <div class="swiper-pagination bottom-0"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="container-fluid block1">
    <div class="container">
      <h2 class="text-center">Немного <span class="blue">статистики</span> на 29 ноября 2024г.:</h2>
      <div class="row row-cols-1 row-cols-xl-4 row-cols-sm-2 statistics">
        <div class="col mb-xl-0 mb-3">
          <div class="card k1 h-100">
            <p class="card-text">Загружено проектов:</p>
            <span>1302</span>
            <img src="im/k1.png" class="img-fluid" alt="...">
          </div>
        </div>
        <div class="col mb-xl-0 mb-3">
          <div class="card k2 h-100">
            <p class="card-text">Сформировано калькуляций:</p>
            <span>906</span>
            <img src="im/k2.png" class="img-fluid" alt="...">
          </div>
        </div>
        <div class="col mb-md-0 mb-3">
          <div class="card k3 h-100">
            <p class="card-text">Посетителей сайта:</p>
            <span>11 227</span>
            <img src="im/k3.png" class="img-fluid" alt="...">
          </div>
        </div>
        <div class="col">
          <div class="card k4 h-100">
            <p class="card-text">Отзывов о сервисе:</p>
            <span>4</span>
            <img src="im/k4.png" class="img-fluid" alt="...">
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer class="footer mt-auto">
    <div class="container">
      <div class="row justify-content-between align-items-center">
        <div class="col-xl-4 col-sm-6">
          <p class="mb-sm-0 mb-4">2024© PoSmetam.ru – сервис для расчёта калькуляций по проектам с помощью нейросетей.
          </p>
        </div>
        <div class="col-xl-4 col-sm-5 col-10">
          <div class="d-flex justify-content-between mb-md-4 mb-2">
            <a href="" class="me-2"><img src="im/i1.svg" alt="" class="img-fluid"></a>
            <a href="" class="mx-2"><img src="im/i2.svg" alt="" class="img-fluid"></a>
            <a href="" class="mx-2"><img src="im/i3.svg" alt="" class="img-fluid"></a>
            <a href="" class="ms-2"><img src="im/i4.svg" alt="" class="img-fluid"></a>
          </div>
          <div class="d-flex justify-content-between">
            <a href="" class="me-2"><img src="im/i5.svg" alt="" class="img-fluid"></a>
            <a href="" class="mx-2"><img src="im/i6.svg" alt="" class="img-fluid"></a>
            <a href="" class="mx-2"><img src="im/i7.svg" alt="" class="img-fluid"></a>
            <a href="" class="ms-2"><img src="im/i8.svg" alt="" class="img-fluid"></a>
          </div>
        </div>
      </div>
      <ul class="nav footer_menu">
        <li class="nav-item">
          <a class="nav-link" href="#">История сайта</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">Реквизиты</a>
        </li>
        <li class="nav-item">
          <a class="nav-link me-0" href="#">Договор оферта</a>
        </li>
      </ul>

    </div>
  </footer>




  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
  <script src="bootstrap-5.3.3/dist/js/bootstrap.min.js"></script>
  <script src="cmn-toggle-switch/cmn-toggle-switch.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.0.2/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="js/js.js"></script>


  <script>

    const OPENAI_API_KEY = "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"; // Вставь API-ключ OpenAI
    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";


    // Функция для обработки PDF и получения данных
    async function processPDF() {
      const fileInput = document.getElementById("pdfInput").files[0];
      if (!fileInput) return alert("Выберите PDF!");

      const reader = new FileReader();
      reader.onload = async function () {
        const typedArray = new Uint8Array(reader.result);
        const pdf = await pdfjsLib.getDocument(typedArray).promise;
        let extractedText = "";

        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const textContent = await page.getTextContent();
          extractedText += textContent.items.map(item => item.str).join(" ") + "\n";
        }

        // После обработки текста с PDF - анализируем данные с помощью ИИ
        analyzeWithAI(extractedText);
        openPopup(); // Открываем попап после получения ответа
      };
      reader.readAsArrayBuffer(fileInput);
    }

    // Функция для анализа данных с ИИ
    async function analyzeWithAI(text) {
      const prompt = `В этом тексте содержится смета. Постарайся не писать ничего, кроме JSON. Не учитывай цены, указанные в тексте, а вместо этого используй ориентировочные цены товаров в кыргызских сомах. Для каждого товара также укажи возможных поставщиков из города Ош, используя примерные данные. 

Структура вывода:
[
  {
    "item": "Название товара", 
    "quantity": "10 или 8 м2", 
    "price": "1000",  // Примерная цена в сомах
    "fullprice": 10000, // Общая цена товаров
    "seller": "Магазин два прораба"  // Примерный поставщик
  },
  ...
]

ТЕКСТ: ${text}
`;

      try {
        const response = await axios.post("https://api.openai.com/v1/chat/completions", {
          model: "gpt-4o",
          messages: [{ role: "user", content: prompt }],
          temperature: 0
        }, {
          headers: { "Authorization": `Bearer ${OPENAI_API_KEY}`, "Content-Type": "application/json" }
        });

        const responseContent = response.data.choices[0].message.content;

        // Пытаемся найти и извлечь JSON
        const jsonString = responseContent.match(/\[.*\]/s);
        if (jsonString) {
          const parsedData = JSON.parse(jsonString[0]);
          displayData(parsedData); // Отображаем полученные данные в таблице
        } else {
          console.error("JSON не найден в ответе");
          alert("Ответ от ИИ не содержит корректного JSON.");
        }
      } catch (error) {
        console.error("Ошибка при запросе к ИИ:", error);
        alert("Произошла ошибка при получении данных от ИИ.");
      }
    }

    // Функция для отображения данных в таблице
    function displayData(data) {
      const tableBody = document.querySelector("#dataTable tbody");
      tableBody.innerHTML = ""; // Очищаем таблицу перед добавлением новых данных

      let totalFullPrice = 0;
      let totalItems = data.length; // Количество позиций

      if (Array.isArray(data) && data.length > 0) {
        data.forEach(row => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${row.item}</td><td>${row.quantity}</td><td>${row.price}</td><td>${row.fullprice}</td><td>${row.seller}</td>`;
          tableBody.appendChild(tr);

          // Считаем общую стоимость
          totalFullPrice += row.fullprice ? parseFloat(row.fullprice) : 0;
        });

        // Добавляем строку с итогами
        const totalRow = document.createElement("tr");
        totalRow.innerHTML = `<td><strong>ИТОГО</strong></td><td>-</td><td>-</td><td><strong>${totalFullPrice}</strong></td><td>-</td>`;
        tableBody.appendChild(totalRow);
      } else {
        console.error("Данные для таблицы имеют неверную структуру:", data);
        alert("Данные для таблицы имеют неверную структуру.");
      }
    }


    // Функция для открытия попапа
    function openPopup() {
      const popupOverlay = document.getElementById('popupOverlay');
      popupOverlay.style.display = 'flex'; // Показываем попап
    }

    // Функция для закрытия попапа
    function closePopup() {
      const popupOverlay = document.getElementById('popupOverlay');
      popupOverlay.style.display = 'none'; // Закрываем попап
    }

    // Функция для закрытия попапа, если клик был вне его
    function closePopupFromOverlay(event) {
      if (event.target === document.getElementById('popupOverlay')) {
        closePopup();
      }
    }

    // Функция для сохранения данных в Excel
    function exportToExcel() {
      const table = document.getElementById("dataTable");
      const worksheet = XLSX.utils.table_to_sheet(table);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "Смета");

      // Сохраняем файл
      XLSX.writeFile(workbook, "smeta.xlsx");
    }



  </script>
</body>

</html>